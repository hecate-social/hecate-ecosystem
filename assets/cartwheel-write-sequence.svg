<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 600">
  <defs>
    <!-- Gradients -->
    <linearGradient id="cmdGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#7c3aed"/>
      <stop offset="100%" stop-color="#a855f7"/>
    </linearGradient>
    <linearGradient id="eventGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#059669"/>
      <stop offset="100%" stop-color="#10b981"/>
    </linearGradient>
    <linearGradient id="flowGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#3b82f6"/>
      <stop offset="100%" stop-color="#06b6d4"/>
    </linearGradient>

    <!-- Filters -->
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
      <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>

    <!-- Markers -->
    <marker id="arrowWhite" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/>
    </marker>
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <marker id="arrowGreen" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#10b981"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f97316"/>
    </marker>
    <marker id="arrowPurple" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#a855f7"/>
    </marker>
  </defs>

  <style>
    @keyframes flowRight {
      0% { stroke-dashoffset: 30; }
      100% { stroke-dashoffset: 0; }
    }
    @keyframes flowLeft {
      0% { stroke-dashoffset: -30; }
      100% { stroke-dashoffset: 0; }
    }
    @keyframes pulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    @keyframes eventPulse {
      0%, 100% { transform: scaleX(1); }
      50% { transform: scaleX(1.02); }
    }
    .flow-right { stroke-dasharray: 15 8; animation: flowRight 1s linear infinite; }
    .flow-left { stroke-dasharray: 15 8; animation: flowLeft 1s linear infinite; }
    .pulse { animation: pulse 2s ease-in-out infinite; }
    .event-pulse { animation: eventPulse 3s ease-in-out infinite; transform-origin: left center; }
  </style>

  <!-- Background -->
  <rect width="1000" height="600" fill="#0f172a"/>

  <!-- Grid -->
  <defs>
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1e293b" stroke-width="0.5"/>
    </pattern>
  </defs>
  <rect width="1000" height="600" fill="url(#grid)" opacity="0.5"/>

  <!-- Title -->
  <text x="500" y="40" text-anchor="middle" font-family="system-ui, sans-serif" font-size="24" font-weight="bold" fill="#fff">Write Sequence (CMD)</text>
  <text x="500" y="62" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#94a3b8">How commands enter the system and become events</text>

  <!-- Sequence number badges -->
  <g font-family="system-ui, sans-serif" font-size="10" font-weight="bold">
    <circle cx="85" cy="120" r="12" fill="#3b82f6"/><text x="85" y="124" text-anchor="middle" fill="#fff">1</text>
    <circle cx="195" cy="120" r="12" fill="#3b82f6"/><text x="195" y="124" text-anchor="middle" fill="#fff">2</text>
    <circle cx="335" cy="120" r="12" fill="#3b82f6"/><text x="335" y="124" text-anchor="middle" fill="#fff">3</text>
    <circle cx="475" cy="120" r="12" fill="#3b82f6"/><text x="475" y="124" text-anchor="middle" fill="#fff">4</text>
    <circle cx="615" cy="120" r="12" fill="#3b82f6"/><text x="615" y="124" text-anchor="middle" fill="#fff">5</text>
    <circle cx="755" cy="120" r="12" fill="#3b82f6"/><text x="755" y="124" text-anchor="middle" fill="#fff">6</text>
    <circle cx="895" cy="120" r="12" fill="#3b82f6"/><text x="895" y="124" text-anchor="middle" fill="#fff">7</text>
  </g>

  <!-- Main Flow Section -->
  <g transform="translate(30, 145)">
    <!-- API / User -->
    <g>
      <rect x="20" y="0" width="90" height="80" rx="8" fill="#1e293b" stroke="#3b82f6" stroke-width="2"/>
      <text x="65" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#fff">API</text>
      <circle cx="65" cy="55" r="15" fill="#3b82f6" opacity="0.3"/>
      <circle cx="65" cy="50" r="6" fill="#60a5fa"/>
      <path d="M53,65 Q65,72 77,65" fill="none" stroke="#60a5fa" stroke-width="2"/>
      <text x="65" y="90" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">User Request</text>
    </g>

    <!-- Arrow -->
    <line x1="115" y1="40" x2="150" y2="40" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)" class="flow-right"/>

    <!-- Requester -->
    <g transform="translate(155, 0)">
      <rect x="0" y="10" width="80" height="60" rx="6" fill="#0369a1" stroke="#3b82f6" stroke-width="2"/>
      <text x="40" y="45" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff">REQUESTER</text>
      <text x="40" y="90" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Sends HOPE</text>
    </g>

    <!-- Arrow with HOPE label -->
    <g>
      <line x1="240" y1="40" x2="290" y2="40" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)" class="flow-right"/>
      <rect x="248" y="20" width="40" height="16" rx="3" fill="#3b82f6"/>
      <text x="268" y="32" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#fff">HOPE</text>
    </g>

    <!-- Responder -->
    <g transform="translate(295, 0)">
      <rect x="0" y="10" width="80" height="60" rx="6" fill="#c2410c" stroke="#f97316" stroke-width="2"/>
      <text x="40" y="45" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff">RESPONDER</text>
      <text x="40" y="90" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Receives HOPE</text>
    </g>

    <!-- Arrow -->
    <line x1="380" y1="40" x2="420" y2="40" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrowWhite)" class="flow-right"/>

    <!-- Command Pipeline -->
    <g transform="translate(425, 0)">
      <rect x="0" y="5" width="100" height="70" rx="6" fill="#1e293b" stroke="#64748b" stroke-width="2"/>
      <text x="50" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">COMMAND</text>
      <text x="50" y="45" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">PIPELINE</text>
      <text x="50" y="62" text-anchor="middle" font-family="monospace" font-size="8" fill="#64748b">maybe_*.erl</text>
      <text x="50" y="90" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Validates</text>
    </g>

    <!-- Arrow -->
    <line x1="530" y1="40" x2="570" y2="40" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrowWhite)" class="flow-right"/>

    <!-- ES Aggregate -->
    <g transform="translate(575, 0)">
      <rect x="0" y="5" width="80" height="70" rx="6" fill="#2d1b4e" stroke="#a855f7" stroke-width="2" filter="url(#glow)"/>
      <text x="40" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">ES</text>
      <text x="40" y="45" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">AGGREGATE</text>
      <text x="40" y="62" text-anchor="middle" font-family="monospace" font-size="8" fill="#c4b5fd">*_aggregate</text>
      <text x="40" y="90" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Emits EVENT</text>
    </g>

    <!-- Arrow -->
    <line x1="660" y1="40" x2="700" y2="40" stroke="#a855f7" stroke-width="2" marker-end="url(#arrowPurple)" class="flow-right"/>

    <!-- Event -->
    <g transform="translate(705, 0)">
      <rect x="0" y="15" width="70" height="50" rx="6" fill="url(#eventGrad)"/>
      <text x="35" y="45" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff">EVENT</text>
      <text x="35" y="90" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Domain Fact</text>
    </g>

    <!-- Arrow -->
    <line x1="780" y1="40" x2="820" y2="40" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)" class="flow-right"/>

    <!-- Event Log -->
    <g transform="translate(825, 0)">
      <rect x="0" y="0" width="120" height="80" rx="6" fill="#1e293b" stroke="#10b981" stroke-width="2"/>
      <text x="60" y="20" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff">EVENT LOG</text>
      <text x="60" y="35" text-anchor="middle" font-family="monospace" font-size="9" fill="#64748b">ReckonDB</text>

      <!-- Event streams visualization -->
      <g transform="translate(10, 42)">
        <rect x="0" y="0" width="100" height="8" rx="2" fill="#10b981" class="event-pulse"/>
        <rect x="0" y="10" width="80" height="8" rx="2" fill="#059669" class="event-pulse"/>
        <rect x="0" y="20" width="90" height="8" rx="2" fill="#047857" class="event-pulse"/>
      </g>
      <text x="60" y="95" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#64748b">Persisted</text>
    </g>
  </g>

  <!-- FEEDBACK return path -->
  <g transform="translate(30, 250)">
    <path d="M 825 0 L 825 20 L 155 20 L 155 0" fill="none" stroke="#f97316" stroke-width="2" stroke-dasharray="8 4" marker-end="url(#arrowOrange)"/>
    <rect x="450" y="8" width="80" height="20" rx="4" fill="#f97316"/>
    <text x="490" y="22" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">FEEDBACK</text>
  </g>

  <!-- Second Flow: External FACT → Command -->
  <g transform="translate(30, 310)">
    <rect x="0" y="0" width="940" height="130" rx="8" fill="#1e293b" stroke="#334155" stroke-width="1"/>
    <text x="20" y="25" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#94a3b8">Alternative Entry: External FACT from Mesh</text>

    <!-- Mesh Cloud -->
    <g transform="translate(50, 50)">
      <ellipse cx="50" cy="30" rx="50" ry="30" fill="#1e293b" stroke="#10b981" stroke-width="2"/>
      <text x="50" y="27" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">MESH</text>
      <text x="50" y="40" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#10b981">FACT</text>
    </g>

    <!-- Arrow -->
    <line x1="155" y1="80" x2="200" y2="80" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)" class="flow-right"/>

    <!-- Listener -->
    <g transform="translate(205, 50)">
      <rect x="0" y="10" width="80" height="50" rx="6" fill="#059669" stroke="#10b981" stroke-width="2"/>
      <text x="40" y="40" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff">LISTENER</text>
    </g>

    <!-- Arrow with conversion label -->
    <g>
      <line x1="290" y1="80" x2="350" y2="80" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrowWhite)" class="flow-right"/>
      <text x="320" y="72" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#64748b">converts to</text>
    </g>

    <!-- Command -->
    <g transform="translate(355, 50)">
      <rect x="0" y="10" width="80" height="50" rx="6" fill="url(#cmdGrad)"/>
      <text x="40" y="40" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff">COMMAND</text>
    </g>

    <!-- Arrow -->
    <line x1="440" y1="80" x2="490" y2="80" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrowWhite)" class="flow-right"/>

    <!-- Same pipeline text -->
    <text x="540" y="85" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#64748b">→ Same pipeline as above →</text>

    <!-- Dotted arrow to main flow -->
    <line x1="640" y1="80" x2="700" y2="80" stroke="#64748b" stroke-width="1" stroke-dasharray="4 2"/>
  </g>

  <!-- Emitter output flow -->
  <g transform="translate(30, 460)">
    <rect x="0" y="0" width="940" height="90" rx="8" fill="#1e293b" stroke="#334155" stroke-width="1"/>
    <text x="20" y="25" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#94a3b8">Output: Publishing EVENTs as FACTs to Mesh</text>

    <!-- Event from log -->
    <g transform="translate(50, 40)">
      <rect x="0" y="5" width="70" height="40" rx="4" fill="url(#eventGrad)"/>
      <text x="35" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">EVENT</text>
    </g>

    <!-- Arrow -->
    <line x1="125" y1="65" x2="175" y2="65" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)" class="flow-right"/>

    <!-- Emitter -->
    <g transform="translate(180, 40)">
      <rect x="0" y="5" width="80" height="40" rx="6" fill="#7c3aed" stroke="#a855f7" stroke-width="2"/>
      <text x="40" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#fff">EMITTER</text>
    </g>

    <!-- Arrow with conversion -->
    <g>
      <line x1="265" y1="65" x2="330" y2="65" stroke="#a855f7" stroke-width="2" marker-end="url(#arrowPurple)" class="flow-right"/>
      <text x="297" y="57" text-anchor="middle" font-family="system-ui, sans-serif" font-size="8" fill="#64748b">converts to</text>
    </g>

    <!-- FACT -->
    <g transform="translate(335, 40)">
      <rect x="0" y="5" width="60" height="40" rx="4" fill="#10b981"/>
      <text x="30" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">FACT</text>
    </g>

    <!-- Arrow -->
    <line x1="400" y1="65" x2="450" y2="65" stroke="#10b981" stroke-width="2" marker-end="url(#arrowGreen)" class="flow-right"/>

    <!-- Mesh -->
    <g transform="translate(455, 35)">
      <ellipse cx="50" cy="30" rx="50" ry="30" fill="#1e293b" stroke="#10b981" stroke-width="2"/>
      <text x="50" y="27" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fff">MESH</text>
      <text x="50" y="40" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#10b981">Published</text>
    </g>

    <!-- Key insight -->
    <g transform="translate(600, 35)">
      <rect x="0" y="0" width="320" height="50" rx="6" fill="#0f172a" stroke="#f59e0b" stroke-width="1"/>
      <text x="160" y="20" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" font-weight="bold" fill="#fbbf24">KEY INSIGHT</text>
      <text x="160" y="38" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" fill="#94a3b8">Emitters convert internal EVENTs to external FACTs</text>
    </g>
  </g>

  <!-- Attribution -->
  <text x="970" y="590" text-anchor="end" font-family="system-ui, sans-serif" font-size="9" fill="#475569">macula-hecate • Write Sequence</text>
</svg>
