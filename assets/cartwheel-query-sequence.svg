<?xml version="1.0" encoding="UTF-8"?>
<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 900 500">
  <defs>
    <!-- Gradients -->
    <linearGradient id="controllerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#0ea5e9"/>
      <stop offset="100%" stop-color="#3b82f6"/>
    </linearGradient>
    <linearGradient id="providerGrad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#059669"/>
      <stop offset="100%" stop-color="#10b981"/>
    </linearGradient>
    <linearGradient id="dbGrad" x1="0%" y1="0%" x2="0%" y2="100%">
      <stop offset="0%" stop-color="#dc2626"/>
      <stop offset="100%" stop-color="#991b1b"/>
    </linearGradient>

    <!-- Filters -->
    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
      <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
      <feMerge><feMergeNode in="coloredBlur"/><feMergeNode in="SourceGraphic"/></feMerge>
    </filter>

    <!-- Markers -->
    <marker id="arrowBlue" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#3b82f6"/>
    </marker>
    <marker id="arrowOrange" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#f97316"/>
    </marker>
    <marker id="arrowWhite" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#94a3b8"/>
    </marker>
  </defs>

  <style>
    @keyframes queryFlow {
      0% { stroke-dashoffset: 20; }
      100% { stroke-dashoffset: 0; }
    }
    @keyframes responseFlow {
      0% { stroke-dashoffset: 20; }
      100% { stroke-dashoffset: 0; }
    }
    @keyframes userPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    @keyframes dbGlow {
      0%, 100% { filter: none; }
      50% { filter: url(#glow); }
    }
    .query-flow { stroke-dasharray: 12 6; animation: queryFlow 1s linear infinite; }
    .response-flow { stroke-dasharray: 12 6; animation: responseFlow 1s linear infinite reverse; }
    .user-pulse { animation: userPulse 2s ease-in-out infinite; }
    .db-glow { animation: dbGlow 3s ease-in-out infinite; }
  </style>

  <!-- Background -->
  <rect width="900" height="500" fill="#0f172a"/>

  <!-- Grid -->
  <defs>
    <pattern id="grid" width="40" height="40" patternUnits="userSpaceOnUse">
      <path d="M 40 0 L 0 0 0 40" fill="none" stroke="#1e293b" stroke-width="0.5"/>
    </pattern>
  </defs>
  <rect width="900" height="500" fill="url(#grid)" opacity="0.5"/>

  <!-- Title -->
  <text x="450" y="40" text-anchor="middle" font-family="system-ui, sans-serif" font-size="24" font-weight="bold" fill="#fff">Query Sequence (QRY)</text>
  <text x="450" y="62" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" fill="#94a3b8">How data is retrieved — the read side (FAST!)</text>

  <!-- Main Flow Container -->
  <g transform="translate(50, 100)">

    <!-- User Icon - centered vertically with the flow -->
    <g class="user-pulse">
      <circle cx="40" cy="120" r="35" fill="#1e293b" stroke="#a855f7" stroke-width="3"/>
      <circle cx="40" cy="110" r="12" fill="#a855f7"/>
      <path d="M20,140 Q40,155 60,140" fill="none" stroke="#a855f7" stroke-width="4" stroke-linecap="round"/>
      <text x="40" y="175" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#c4b5fd">USER</text>
    </g>

    <!-- Query Arrow (User to Controller) -->
    <g transform="translate(80, 105)">
      <line x1="0" y1="0" x2="60" y2="0" stroke="#3b82f6" stroke-width="3" marker-end="url(#arrowBlue)" class="query-flow"/>
      <rect x="15" y="-18" width="50" height="16" rx="4" fill="#3b82f6"/>
      <text x="40" y="-6" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" font-weight="bold" fill="#fff">QUERY</text>
    </g>

    <!-- Response Arrow (Controller to User) -->
    <g transform="translate(80, 135)">
      <line x1="60" y1="0" x2="0" y2="0" stroke="#f97316" stroke-width="3" marker-end="url(#arrowOrange)" class="response-flow"/>
      <rect x="15" y="4" width="50" height="16" rx="4" fill="#f97316"/>
      <text x="40" y="15" text-anchor="middle" font-family="system-ui, sans-serif" font-size="9" font-weight="bold" fill="#fff">RESULT</text>
    </g>

    <!-- Controller -->
    <g transform="translate(150, 85)">
      <rect x="0" y="0" width="100" height="70" rx="8" fill="url(#controllerGrad)"/>
      <text x="50" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#fff">Controller</text>
      <text x="50" y="50" text-anchor="middle" font-family="monospace" font-size="9" fill="#bfdbfe">hecate_api_*.erl</text>
      <text x="50" y="-8" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#64748b">HTTP Handler</text>
    </g>

    <!-- Arrow Controller to Provider -->
    <g transform="translate(255, 105)">
      <line x1="0" y1="0" x2="50" y2="0" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)" class="query-flow"/>
    </g>
    <g transform="translate(255, 135)">
      <line x1="50" y1="0" x2="0" y2="0" stroke="#f97316" stroke-width="2" marker-end="url(#arrowOrange)" class="response-flow"/>
    </g>

    <!-- Provider -->
    <g transform="translate(310, 85)">
      <rect x="0" y="0" width="100" height="70" rx="8" fill="url(#providerGrad)"/>
      <text x="50" y="30" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#fff">Provider</text>
      <text x="50" y="50" text-anchor="middle" font-family="monospace" font-size="9" fill="#a7f3d0">find_*.erl</text>
      <text x="50" y="-8" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#64748b">Query Logic</text>
    </g>

    <!-- Arrow Provider to DB -->
    <g transform="translate(415, 105)">
      <line x1="0" y1="0" x2="50" y2="0" stroke="#3b82f6" stroke-width="2" marker-end="url(#arrowBlue)" class="query-flow"/>
    </g>
    <g transform="translate(415, 135)">
      <line x1="50" y1="0" x2="0" y2="0" stroke="#f97316" stroke-width="2" marker-end="url(#arrowOrange)" class="response-flow"/>
    </g>

    <!-- Caches X DB (Cylinder) -->
    <g transform="translate(470, 45)" class="db-glow">
      <rect x="0" y="25" width="120" height="130" rx="4" fill="url(#dbGrad)"/>
      <ellipse cx="60" cy="25" rx="60" ry="20" fill="#ef4444"/>
      <ellipse cx="60" cy="155" rx="60" ry="20" fill="#7f1d1d"/>

      <text x="60" y="75" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#fff">CACHES</text>
      <text x="60" y="95" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#fff">X</text>
      <text x="60" y="115" text-anchor="middle" font-family="system-ui, sans-serif" font-size="14" font-weight="bold" fill="#fff">DB</text>
      <text x="60" y="140" text-anchor="middle" font-family="monospace" font-size="10" fill="#fca5a5">Read Models</text>
    </g>

  </g>

  <!-- Critical Insight Box -->
  <g transform="translate(680, 100)">
    <rect x="0" y="0" width="190" height="140" rx="8" fill="#1e293b" stroke="#dc2626" stroke-width="3"/>
    <rect x="0" y="0" width="190" height="35" rx="8" fill="#dc2626"/>
    <text x="95" y="24" text-anchor="middle" font-family="system-ui, sans-serif" font-size="13" font-weight="bold" fill="#fff">CRITICAL INSIGHT</text>

    <g transform="translate(15, 50)" font-family="system-ui, sans-serif">
      <text x="0" y="0" font-size="11" fill="#fca5a5" font-weight="bold">Queries NEVER touch</text>
      <text x="0" y="18" font-size="11" fill="#fca5a5" font-weight="bold">the Event Log!</text>

      <text x="0" y="45" font-size="10" fill="#94a3b8">They only read from</text>
      <text x="0" y="60" font-size="10" fill="#94a3b8">pre-computed, denormalized</text>
      <text x="0" y="75" font-size="10" fill="#94a3b8">read models.</text>
    </g>
  </g>

  <!-- Speed Indicator -->
  <g transform="translate(680, 260)">
    <rect x="0" y="0" width="190" height="100" rx="8" fill="#1e293b" stroke="#22c55e" stroke-width="2"/>
    <text x="95" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="12" font-weight="bold" fill="#22c55e">WHY IT'S FAST</text>
    <line x1="15" y1="35" x2="175" y2="35" stroke="#334155"/>

    <g transform="translate(15, 50)" font-family="system-ui, sans-serif" font-size="10">
      <circle cx="6" cy="4" r="4" fill="#22c55e"/>
      <text x="18" y="8" fill="#94a3b8">Direct table reads</text>

      <circle cx="6" cy="26" r="4" fill="#22c55e"/>
      <text x="18" y="30" fill="#94a3b8">No event replay</text>

      <circle cx="6" cy="48" r="4" fill="#22c55e"/>
      <text x="18" y="52" fill="#94a3b8">Pre-aggregated data</text>
    </g>
  </g>

  <!-- Event Log (crossed out) -->
  <g transform="translate(50, 380)">
    <rect x="0" y="0" width="150" height="60" rx="6" fill="#1e293b" stroke="#64748b" stroke-width="1" stroke-dasharray="4 2" opacity="0.5"/>
    <text x="75" y="25" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" fill="#64748b">Event Log</text>
    <text x="75" y="42" text-anchor="middle" font-family="monospace" font-size="9" fill="#475569">ReckonDB</text>

    <!-- X marks -->
    <line x1="10" y1="10" x2="140" y2="50" stroke="#dc2626" stroke-width="3"/>
    <line x1="140" y1="10" x2="10" y2="50" stroke="#dc2626" stroke-width="3"/>

    <text x="200" y="35" font-family="system-ui, sans-serif" font-size="10" fill="#dc2626" font-weight="bold">NOT USED IN QUERIES!</text>
  </g>

  <!-- Flow Summary -->
  <g transform="translate(420, 390)">
    <rect x="0" y="0" width="450" height="55" rx="6" fill="#1e293b" stroke="#334155"/>
    <text x="225" y="20" text-anchor="middle" font-family="system-ui, sans-serif" font-size="11" font-weight="bold" fill="#94a3b8">FLOW: User → Controller → Provider → Caches/DB → Response</text>
    <text x="225" y="40" text-anchor="middle" font-family="system-ui, sans-serif" font-size="10" fill="#64748b">Simple, fast, direct reads from optimized tables</text>
  </g>

  <!-- Attribution -->
  <text x="870" y="490" text-anchor="end" font-family="system-ui, sans-serif" font-size="9" fill="#475569">macula-hecate • Query Sequence</text>
</svg>
